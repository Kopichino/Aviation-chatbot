<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MH Aviation - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-7xl mx-auto">
      <h1 class="text-3xl font-bold text-gray-800 mb-8">
        ‚úàÔ∏è MH Cockpit Admin Dashboard
      </h1>

      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead class="bg-slate-800 text-white">
              <tr>
                <th class="p-4">Name</th>
                <th class="p-4">Email</th>
                <th class="p-4">Phone</th>
                <th class="p-4">School / City</th>
                <th class="p-4">Last Updated</th>
                <th class="p-4">Actions</th>
              </tr>
            </thead>
            <tbody id="leads-table-body" class="text-gray-700"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div
      id="history-modal"
      class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm"
    >
      <div
        class="bg-white rounded-lg w-11/12 md:w-2/3 lg:w-1/2 h-3/4 flex flex-col p-6 shadow-2xl transform transition-all"
      >
        <div class="flex justify-between items-center mb-4 border-b pb-2">
          <h3 class="text-xl font-bold text-gray-800">Chat History</h3>
          <button
            onclick="closeModal()"
            class="text-gray-500 hover:text-red-600 font-bold text-2xl transition-colors"
          >
            &times;
          </button>
        </div>

        <div
          id="modal-content"
          class="flex-1 overflow-y-auto space-y-4 bg-gray-50 p-4 rounded-lg border border-gray-200"
        ></div>

        <div class="mt-4 text-right">
          <button
            onclick="closeModal()"
            class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-700 transition"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <script>
      // GLOBAL VARIABLE to store leads data
      let allLeadsData = [];

      // 1. Fetch Data
      async function fetchLeads() {
        try {
          const response = await fetch("/api/leads");
          const data = await response.json();

          // Save data globally so we can access it later
          allLeadsData = data.leads;

          renderTable(allLeadsData);
        } catch (error) {
          console.error("Error fetching leads:", error);
          alert("Failed to load data. Is the backend running?");
        }
      }

      // 2. Draw the Table
      function renderTable(leads) {
        const tbody = document.getElementById("leads-table-body");
        tbody.innerHTML = "";

        if (leads.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="p-4 text-center text-gray-500">No leads found yet.</td></tr>';
          return;
        }

        leads.forEach((lead, index) => {
          const tr = document.createElement("tr");
          tr.className = "border-b hover:bg-blue-50 transition duration-150";

          // We pass the INDEX (0, 1, 2...) to the function, not the messy object
          tr.innerHTML = `
                    <td class="p-4 font-semibold text-gray-800">${
                      lead.name || "N/A"
                    }</td>
                    <td class="p-4 text-blue-600 font-medium">${lead.email}</td>
                    <td class="p-4 text-gray-700 font-mono">${
                      lead.phone || "-"
                    }</td>
                    <td class="p-4 text-gray-600">${lead.school || "-"}, ${
            lead.city || "-"
          }</td>
                    <td class="p-4 text-sm text-gray-500">${
                      lead.last_updated || "Just now"
                    }</td>
                    <td class="p-4">
                        <button onclick="openHistory(${index})" 
                                class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition-all transform hover:scale-105">
                            View Chat
                        </button>
                    </td>
                `;
          tbody.appendChild(tr);
        });
      }

      // 3. Open Modal (Using Index)
      function openHistory(index) {
        const lead = allLeadsData[index]; // Look up the lead from global data
        const history = lead.chat_history || [];

        const modal = document.getElementById("history-modal");
        const content = document.getElementById("modal-content");
        content.innerHTML = "";

        if (history.length === 0) {
          content.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-400">
                        <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        <p>No chat history available.</p>
                    </div>`;
        } else {
          history.forEach((msg) => {
            const div = document.createElement("div");
            // Check various roles (human, user, ai, bot) to be safe
            const isBot =
              msg.role === "ai" ||
              msg.role === "bot" ||
              msg.role === "assistant";

            div.className = `flex flex-col max-w-[85%] ${
              isBot ? "self-start" : "self-end items-end"
            }`;

            const bubbleColor = isBot
              ? "bg-white border-gray-200 text-gray-800"
              : "bg-cyan-600 text-white";
            const align = isBot ? "text-left" : "text-right";
            const icon = isBot ? "ü§ñ" : "üë§";

            div.innerHTML = `
                        <div class="flex items-center space-x-2 mb-1 ${
                          isBot ? "" : "flex-row-reverse space-x-reverse"
                        }">
                            <span class="text-sm">${icon}</span>
                            <span class="text-xs font-bold text-gray-500 uppercase">${
                              isBot ? "AI Assistant" : "User"
                            }</span>
                        </div>
                        <div class="${bubbleColor} p-3 rounded-2xl shadow-sm border ${align} text-sm">
                            ${msg.content}
                        </div>
                        <span class="text-[10px] text-gray-400 mt-1 px-1">${
                          msg.timestamp
                            ? msg.timestamp.split(" ")[1].split(".")[0]
                            : ""
                        }</span>
                    `;
            content.appendChild(div);
          });
        }
        modal.classList.remove("hidden");
      }

      function closeModal() {
        document.getElementById("history-modal").classList.add("hidden");
      }

      // Close modal if clicking outside
      document
        .getElementById("history-modal")
        .addEventListener("click", function (e) {
          if (e.target === this) closeModal();
        });

      // Run on load
      fetchLeads();
    </script>
  </body>
</html>
